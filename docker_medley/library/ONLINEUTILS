(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "13-Dec-2025 22:45:29" {DSK}<home>medley>il>medley>library>ONLINEUTILS.;1 3336   

      :EDIT-BY "fgh"

      :CHANGES-TO (VARS ONLINEUTILSCOMS)
                  (FNS Online.WebfileURL Online.OpenWebfile)

      :PREVIOUS-DATE "18-Nov-2025 22:54:33" {DSK}<usr>local>interlisp>medley>library>ONLINEUTILS.;1
)


(PRETTYCOMPRINT ONLINEUTILSCOMS)

(RPAQQ ONLINEUTILSCOMS [(FILES PSEUDOHOSTS)
                        (FNS ShellHttpGet Online.WebfileURL Online.OpenWebfile)
                        (P (PSEUDOHOST 'WEBFILES (CONCAT LOGINDIR "/webfiles"])

(FILESLOAD PSEUDOHOSTS)
(DEFINEQ

(ShellHttpGet
  [LAMBDA (URL OUTFILENAME)                                  (* ; "Edited 18-Nov-2025 22:54 by FGH")

    (* ;; "Download a file specified by URL from the internet and place it in anew file name OUTFILENAME.   OUTFILENAME will be versioned if it is on a versioned file device.   Protocol of URL must be http: or https:.  Uses wget (if it exists) or curl (if it exists) via a ShellCommand.  It is an error if the underlying system doesn't have either wget or curl.")
                                                             (* ; "Edited 18-Nov-2025 22:39 by FGH")
    (LET ((UURL (U-CASE URL)))
         (if (NOT (OR (STRPOS "HTTP:://" UURL NIL NIL T)
                      (STRPOS "HTTPS://" UURL NIL NIL T)))
             then (ERROR "ShellHttpGet URL argument is not a HTTP:// or HTTPS:// Url")))
    (LET* ((WGET (ShellWhich "wget"))
           (CURL (if (NULL WGET)
                     then (ShellWhich "curl")
                   else NIL))
           (OUTNAME (OUTFILEP OUTFILENAME))
           (TMPFILE (CONCAT "/tmp/wget" (CLOCK)))
           (UNIXFILE (CONCAT "{UNIX}" TMPFILE))
           (CMD (if WGET
                    then (CONCAT WGET " " URL " -O " TMPFILE)
                  elseif CURL
                    then (CONCAT CURL " " URL " --output " TMPFILE)
                  else NIL)))
          (if (NULL CMD)
              then (ERROR "ShellHttpGet - neither wget nor curl are available on this system"))
          (ShellCommand CMD)
          (COPYFILE UNIXFILE OUTNAME)
          (DELFILE UNIXFILE)
          OUTNAME])

(Online.WebfileURL
  [LAMBDA (WebFilePath)                                      (* ; "Edited 13-Dec-2025 22:40 by fgh")

    (* ;; "Return the URL that will acess a webfile using the OIO https server")

    (* ;; "WebfilePath is the path for the file below {WEBFILES}")
                                                             (* ; "Edited 13-Dec-2025 21:59 by fgh")
    (CONCAT "https://online.interlisp.org:" (UNIX-GETENV "OIO_WEBFILES_PORT")
           "/" WebFilePath])

(Online.OpenWebfile
  [LAMBDA (WebFilePath)                                      (* ; "Edited 13-Dec-2025 22:44 by fgh")

    (* ;; "Open a Webfile in a browser using the Online HTTPS server to access the file in the Medley file system.")

    (* ;; " Webfiles are always tored in {WEBFILES}")

    (* ;; " WebfilePath is the path to the file below {WEBFILES}")

    (ShellOpen (Online.WebfileURL WebFilePath])
)

(PSEUDOHOST 'WEBFILES (CONCAT LOGINDIR "/webfiles"))
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (671 3259 (ShellHttpGet 681 . 2310) (Online.WebfileURL 2312 . 2817) (Online.OpenWebfile 
2819 . 3257)))))
STOP
